<mat-drawer-container class="drawer-container" autosize>
  <!-- Drawer bên phải: Form Supplier / Bank Account -->
  <mat-drawer
    #drawer
    position="end"
    mode="over"
    class="drawer"
    [disableClose]="loading"
    (closed)="onDrawerClosed()"
  >
    <!-- Header chung -->
    <div class="drawer-header">
      <h3 *ngIf="drawerMode==='supplier'">
        {{ editingId ? 'Edit supplier' : 'Create supplier' }}
      </h3>
      <h3 *ngIf="drawerMode==='bank'">Supplier Bank Account</h3>

      <span class="spacer"></span>

      <!-- Mở full page (tuỳ chọn) -->
      <a
        *ngIf="drawerMode==='bank' && selectedSupplierId"
        mat-stroked-button
        [routerLink]="['/partners','suppliers', selectedSupplierId, 'bank-account']"
      >
        Open full page
      </a>

      <button mat-icon-button type="button" (click)="drawer.close()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Mode: Supplier form -->
    <form
      *ngIf="drawerMode==='supplier'"
      [formGroup]="form"
      class="form"
      (ngSubmit)="save()"
    >
      <mat-form-field appearance="outline">
        <mat-label>Code</mat-label>
        <input
          matInput
          formControlName="code"
          [readonly]="!!editingId"
          appUppercase
        />
        <mat-hint>Để trống để hệ thống tự sinh (ví dụ SUP-000001).</mat-hint>
        <mat-error *ngIf="form.controls.code.invalid && form.controls.code.touched">
          Code ≤ 50, A-Z/0-9/_-.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Name *</mat-label>
        <input matInput formControlName="name" />
        <mat-error *ngIf="form.controls.name.invalid && form.controls.name.touched">
          Required. Max 200.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Short name</mat-label>
        <input matInput formControlName="shortName" />
      </mat-form-field>

      <div class="grid-2">
        <mat-form-field appearance="outline">
          <mat-label>Currency *</mat-label>
          <input
            matInput
            maxlength="3"
            formControlName="defaultCurrency"
            appUppercase
          />
          <mat-error
            *ngIf="form.controls.defaultCurrency.invalid && form.controls.defaultCurrency.touched"
          >
            3 letters (e.g. VND)
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Term (days)</mat-label>
          <input
            matInput
            type="number"
            min="0"
            max="365"
            formControlName="paymentTermDays"
          />
        </mat-form-field>
      </div>

      <div class="grid-2">
        <mat-form-field appearance="outline">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Phone</mat-label>
          <input matInput formControlName="phone" />
        </mat-form-field>
      </div>

      <div class="actions-end">
        <mat-checkbox formControlName="isActive">Active</mat-checkbox>
        <span class="spacer"></span>
        <button mat-stroked-button type="button" (click)="drawer.close()">
          Cancel
        </button>
        <button mat-raised-button color="primary" type="submit">
          Save
        </button>
      </div>
    </form>

    <!-- Mode: Bank Account (nhúng component con) -->
    <div *ngIf="drawerMode==='bank'">
      <expense-supplier-bank-account
        *ngIf="selectedSupplierId"
        [supplierId]="selectedSupplierId"
      ></expense-supplier-bank-account>
    </div>
  </mat-drawer>

  <!-- Nội dung chính -->
  <mat-drawer-content>
    <div class="page">
      <!-- Header -->
      <div class="header">
        <h2>Suppliers</h2>
        <button mat-raised-button color="primary" (click)="openCreate()">
          <mat-icon>add</mat-icon>&nbsp;New Supplier
        </button>
      </div>

      <!-- Errors -->
      <div *ngIf="errorMessages.length" class="errors">
        <div *ngFor="let e of errorMessages">• {{ e }}</div>
      </div>

      <!-- Filters -->
      <div class="filters">
        <mat-form-field appearance="outline">
          <mat-label>Keyword</mat-label>
          <input
            matInput
            [formControl]="keywordCtrl"
            placeholder="Code / Name / TaxCode"
          />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select [(ngModel)]="filters.isActive">
            <mat-option value="">All</mat-option>
            <mat-option value="true">Active</mat-option>
            <mat-option value="false">Inactive</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Currency</mat-label>
          <input
            matInput
            maxlength="3"
            [(ngModel)]="filters.currency"
            placeholder="VND / USD"
            appUppercase
          />
        </mat-form-field>

        <div class="filter-actions">
          <button mat-stroked-button (click)="resetFilters()">Reset</button>
          <button mat-raised-button color="primary" (click)="load(1)">
            <mat-icon>search</mat-icon>&nbsp;Search
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-wrap" [class.loading]="loading">
        <table
          mat-table
          [dataSource]="suppliers"
          [trackBy]="trackById"
          matSort
          (matSortChange)="onSortChange($event)"
          class="mat-elevation-z1"
        >
          <!-- Code -->
          <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="code">Code</th>
            <td mat-cell *matCellDef="let s">
              <code class="mono">{{ s.code }}</code>
            </td>
          </ng-container>

          <!-- Name -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="name">Name</th>
            <td mat-cell *matCellDef="let s">
              <div class="name">
                <div class="main">{{ s.name }}</div>
                <div class="sub" *ngIf="s.shortName">{{ s.shortName }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Currency -->
          <ng-container matColumnDef="currency">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header="defaultCurrency"
            >
              Currency
            </th>
            <td mat-cell *matCellDef="let s" class="center">
              {{ s.defaultCurrency }}
            </td>
          </ng-container>

          <!-- Term -->
          <ng-container matColumnDef="term">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header="paymentTermDays"
            >
              Term (days)
            </th>
            <td mat-cell *matCellDef="let s" class="center">
              {{ s.paymentTermDays }}
            </td>
          </ng-container>

          <!-- Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let s" class="center">
              <mat-chip [color]="s.isActive ? 'primary' : 'warn'" [disableRipple]="true">
                {{ s.isActive ? 'Active' : 'Inactive' }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let s" class="actions">
              <button mat-button (click)="openEdit(s)">
                <mat-icon>edit</mat-icon>&nbsp;Edit
              </button>
              <button mat-stroked-button color="primary" (click)="toggle(s)">
                {{ s.isActive ? 'Deactivate' : 'Activate' }}
              </button>
              <!-- Mở bank ngay trong drawer -->
              <button mat-button (click)="openBank(s)">
                <mat-icon>account_balance</mat-icon>&nbsp;Bank
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

          <!-- No data row (chuẩn Material) -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">
              <div *ngIf="!loading" class="empty-box">
                <div class="title">Không có nhà cung cấp</div>
                <div class="hint">Thử đổi bộ lọc hoặc tạo nhà cung cấp mới.</div>
                <button mat-raised-button color="primary" (click)="openCreate()">
                  <mat-icon>add</mat-icon>&nbsp;New Supplier
                </button>
              </div>
            </td>
          </tr>
        </table>

        <div class="overlay" *ngIf="loading">
          <mat-progress-spinner diameter="36" mode="indeterminate"></mat-progress-spinner>
        </div>
      </div>

      <mat-paginator
        [length]="total"
        [pageSize]="pageSize"
        [pageIndex]="page - 1"
        [pageSizeOptions]="[10, 20, 50]"
        (page)="onPageChange($event)"
      >
      </mat-paginator>
    </div>
  </mat-drawer-content>
</mat-drawer-container>
