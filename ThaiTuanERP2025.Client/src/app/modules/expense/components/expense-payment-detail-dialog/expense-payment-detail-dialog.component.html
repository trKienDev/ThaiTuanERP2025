<div class="dialog">
      <div class="dialog-container">
            <div class="dialog-heading">
                  <div class="dialog-title">
                        <h1>Chi tiết thanh toán</h1>
                  </div>
                  <div class="dialog-exit">
                        <button type="button" class="exit-button" (click)="close()">
                              <span class="text material-icons-outlined">close</span>
                        </button>
                  </div>
            </div>
            <div class="dialog-body">
                  <div class="payment-header display-flex gap-10px align-items-center justify-content-between">
                       <div class="left display-flex gap-10px align-items-center">
                              <div class="payment-status" [@statusChangeFade]="paymentDetail?.status">
                                    <span class="label-status-badge" [ngClass]="(paymentDetail?.status | expensePaymentStatus).class">
                                          {{ (paymentDetail?.status | expensePaymentStatus).text }}
                                    </span>
                              </div>
                              <h3 class="payment-name">{{ paymentDetail?.name }}</h3>
                       </div>
                        <div class="right display-flex gap-10px">
                              <ng-container *ngIf="currentStepStatus$ | async as step">
                                    <div class="payment-expired-badge margin-left-auto" *ngIf="step.expired && isInProgress">
                                          <span class="badge danger-badge">Quá hạn duyệt</span>
                                    </div>
                                    <div *ngIf="!step.expired && canApproveOrReject && isInProgress" class="payment-actions display-flex gap-5px align-items-center">
                                          <kit-spinner-button type="button" cssClass="submit-button"  text="Duyệt" [loading]="approving" [disabled]="submitting" loadingText="Đang duyệt…" (click)="approve()"></kit-spinner-button>
                                          <kit-spinner-button type="button" cssClass="danger-button" text="Từ chối" [loading]="rejecting" [disabled]="submitting" loadingText="Đang từ chối…" (click)="reject()"></kit-spinner-button>
                                          <div class="time-clock-border">
                                                <kit-flip-countdown style="height: 100%;" [timeLeft]="step.seconds"></kit-flip-countdown>
                                          </div>
                                    </div>
                              </ng-container>
                              <ng-container *ngIf="paymentDetail?.status === 3">
                                    <button type="button" class="button pintura-button" [disabled]="submitting" (click)="redirectToOutgoingPaymentRequestPage(paymentId)">
                                          Ghi nhận khoản chi
                                    </button>
                              </ng-container>
                        </div>
                  </div>
                  <div class="payment-infor display-flex flex-column gap-10px">
                        <div class="general-infor primary-card">
                              <div class="card-wrapper">
                                    <div class="card-header">Thông tin thanh toán</div>
                                    <div class="card-body">
                                          <div class="display-flex gap-10px">
                                                <div class="left-side flex-1">
                                                      <div class="column">
                                                            <label for="sub-id">ID chi phí</label>
                                                            <span>{{ paymentDetail?.subId }}</span>
                                                      </div>
                                                      <div class="column">
                                                            <label for="created-by-user" class="align-content-center">Tạo bởi</label>
                                                            <div class="display-flex gap-5px align-items-center">
                                                                  <img class="avatar-user" [src]="paymentDetail?.createdByUser | avatarUrlPipe">
                                                                  <span>{{ paymentDetail?.createdByUser?.fullName}}</span>
                                                            </div>
                                                      </div>
                                                      <div class="column">
                                                            <label for="created-at">Tạo lúc</label>
                                                            <span>{{ paymentDetail?.createdAt | date: 'HH:mm dd/MM/yyyy' }}</span>
                                                      </div>
                                                      <div class="column">
                                                            <label for="hasGoodsReceipt">Đã nhập kho</label>
                                                            <input type="checkbox" [checked]="paymentDetail?.hasGoodsReceipt" disabled style="width: fit-content;"/>
                                                      </div>
                                                      <div class="column">
                                                            <label for="workflow-instance" class="align-content-center">Luồng duyệt</label>
                                                            <ng-container *ngIf="(paymentDetail?.workflowInstance?.steps?.length ?? 0) > 0">
                                                                  <div class="approvers display-flex gap-5px">
                                                                        <ng-container *ngFor="let step of paymentDetail?.workflowInstance?.steps">
                                                                              <ng-container *ngIf="step.approvedByUser">
                                                                                    <div class="expense-step">
                                                                                          <img class="avatar-user approved-user" [src]="step.approvedByUser | avatarUrlPipe">
                                                                                          <span class="status-icon approved-icon">✓</span>
                                                                                    </div>
                                                                              </ng-container>
                                                                              <ng-container *ngIf="step.rejectedByUser">
                                                                                    <div class="expense-step">
                                                                                          <img class="avatar-user rejected-user" [src]="step.rejectedByUser | avatarUrlPipe">
                                                                                          <span class="status-icon rejected-icon">✗</span>
                                                                                    </div>
                                                                              </ng-container>
                                                                        </ng-container>
                                                                  </div>
                                                            </ng-container>
                                                      </div>
                                                </div>
                                                <div class="right-side flex-1">
                                                      <div class="column">
                                                            <label for="supplier">Nhà cung cấp</label>
                                                            <span>{{ paymentDetail?.supplierName }}</span>
                                                      </div>
                                                      <div class="column">
                                                            <label for="bank-name">Tên ngân hàng</label>
                                                            <span>{{ paymentDetail?.bankName }}</span>
                                                      </div>
                                                      <div class="column">
                                                            <label for="bank-account">Số tài khoản</label>
                                                            <span>{{ paymentDetail?.accountNumber }}</span>
                                                      </div>
                                                      <div class="column">
                                                            <label for="beneficiary-name">Người thụ hưởng</label>
                                                            <span>{{ paymentDetail?.beneficiaryName }}</span>
                                                      </div>
                                                      <div class="column">
                                                            <label for="description">Mô tả</label>
                                                            <span>{{ paymentDetail?.description || '---'}}</span>
                                                      </div>
                                                </div>
                                          </div>
                                          <div class="column">
                                                <label for="followers" class="align-content-center">Người theo dõi</label>
                                                <ng-container *ngIf="(paymentDetail?.followers?.length ?? 0) > 0">
                                                      <div class="payment-followers display-flex gap-5px align-items-center">
                                                            <ng-container *ngFor="let follower of paymentDetail?.followers">
                                                                  <div class="payment-follower">
                                                                        <img class="avatar-user" [src]="follower | avatarUrlPipe">
                                                                  </div>
                                                            </ng-container>
                                                      </div>
                                                </ng-container>
                                          </div>
                                          <div class="column">
                                                <label for="attachments">Tệp đính kèm</label>
                                                <ng-container *ngIf="(paymentDetail?.attachments?.length ?? 0) > 0">
                                                      <div class="payment-attachments display-flex gap-5px">
                                                            <ng-container *ngFor="let attachment of paymentDetail?.attachments">
                                                                  <div class="payment-attachment">
                                                                        <span (click)="previewAttachment(attachment.storedFile)">{{ attachment.storedFile.fileName }}</span>
                                                                  </div>
                                                            </ng-container>
                                                      </div>
                                                </ng-container>
                                          </div>
                                    </div>
                              </div>
                        </div>
                        <div class="amount-infor primary-card">
                              <div class="card-wrapper">
                                    <div class="card-body">
                                          <div class="payment-amount-block">
                                                <label for="payment-total-amount">Tổng tiền thanh toán</label>
                                                <span>{{ paymentDetail?.totalWithTax | number: '1.0-0'  }} <span class="label-currency">VND</span></span>
                                          </div>
                                          <div class="payment-amount-block">
                                                <label for="outgoing-amount-paid">Khoản chi đã tạo</label>
                                                <span>{{ paymentDetail?.outgoingAmountPaid | number: '1.0-0'  }} <span class="label-currency">VND</span></span>
                                          </div>
                                          <div class="payment-amount-block">
                                                <label for="remaining-outgoing-amount">Số tiền còn lại</label>
                                                <span>{{ paymentDetail?.remainingOutgoingAmount | number: '1.0-0' }} <span class="label-currency">VND</span></span>
                                          </div>
                                    </div>
                              </div>
                        </div>
                  </div>
                  <div class="payment-tabs">
                        <div class="payment-tab-navigation display-flex gap-5px border-bottom margin-bottom-10px">
                              <button type="button" class="tab-button" [ngClass]="{ 'active': activeTab === 'items' }" (click)="setActiveTab('items')">
                                    Bảng hạng mục
                              </button>
                              <button  type="button" class="tab-button" [ngClass]="{ 'active': activeTab === 'outgoings' }" (click)="setActiveTab('outgoings')">
                                    Khoản tiền ra
                              </button>
                        </div>

                        <ng-container [ngSwitch]="activeTab">
                              <!-- Tab 1: Hạng mục thanh toán -->
                              <ng-container *ngSwitchCase="'items'">
                                    <div [@tabSwitchFade]>
                                          <div class="payment-item-table">
                                                <table class="table">
                                                      <thead>
                                                            <tr>
                                                                  <th style="width: 1%;">#</th>
                                                                  <th>Hạng mục</th>
                                                                  <th class="head-quanity" style="width: 7%;">Số lượng</th>
                                                                  <th>Đơn giá</th>
                                                                  <th>Thành tiền</th>
                                                                  <th class="head-tax" style="width: 6%;">Thuế</th>
                                                                  <th>Số tiền thuế</th>
                                                                  <th>Số tiền có thuế</th>
                                                                  <th class="head-extension">Ngân sách</th>
                                                                  <th class="head-invoice">Hóa đơn</th>
                                                            </tr>
                                                      </thead>
                                                      <tbody>
                                                            <tr *ngFor="let item of paymentDetail?.items; let i = index">
                                                                  <td>{{ i + 1 }}</td>
                                                                  <td class="item-name">{{ item.itemName }}</td>
                                                                  <td class="item-quanity">{{ item.quantity | number:'1.0-0' }}</td>
                                                                  <td class="item-unit-price">{{ item.unitPrice | number:'1.0-0' }} <span class="label-currency">VND</span></td>
                                                                  <td class="item-amount">{{ item.amount | number:'1.0-0' }} <span class="label-currency">VND</span></td>
                                                                  <td class="item-tax">{{ (item.taxRate * 100) | number:'1.0-0' }}%</td>
                                                                  <td class="item-tax-amount">{{ item.taxAmount | number:'1.0-0' }} <span class="label-currency">VND</span></td>
                                                                  <td class="item-total-with-tax">{{ item.totalWithTax | number:'1.0-0' }} <span class="label-currency">VND</span></td>
                                                                  <td class="item-budget-code">{{ item.budgetCode.code }} - {{ item.budgetCode.name }}</td>
                                                                  <td class="item-invoice">
                                                                        <div class="display-flex justify-content-center align-items-center">
                                                                              <button *ngIf="item.invoiceFile"type="button" class="default-button" (click)="previewInvoice(item)">Xem hóa đơn</button>
                                                                              <span *ngIf="!item.invoiceFile" class="text-muted">Không có hóa đơn</span>
                                                                        </div>
                                                                  </td>
                                                            </tr>
                                                      </tbody>
                                                      <tfoot *ngIf="paymentDetail?.items?.length">
                                                            <tr class="total-row">
                                                                  <td colspan="4"><strong>Tổng</strong></td>
                                                                  <td>{{ paymentDetail?.totalAmount | number:'1.0-0' }} VNĐ</td>
                                                                  <td></td>
                                                                  <td>{{ paymentDetail?.totalTax | number:'1.0-0' }} VNĐ</td>
                                                                  <td>{{ paymentDetail?.totalWithTax | number:'1.0-0' }} VNĐ</td>
                                                                  <td colspan="4"></td>
                                                            </tr>
                                                      </tfoot>
                                                </table>
                                          </div>
                                    </div>
                              </ng-container>

                        </ng-container>
                  </div>
            </div>
      </div>
</div>